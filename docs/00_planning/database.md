# データベース設計書

## 1. テーブル設計（ER図）

### 1.1 エンティティ関係図

```
┌─────────────┐          ┌─────────────┐          ┌─────────────┐
│    User     │          │   Message   │          │  ChatRoom   │
├─────────────┤          ├─────────────┤          ├─────────────┤
│ id (PK)     │──┐       │ id (PK)     │       ┌──│ id (PK)     │
│ username    │  │       │ content     │       │  │ name        │
│ email       │  │       │ userId (FK) │◄──────┘  │ createdAt   │
│ password    │  └──────►│ chatRoomId  │          └─────────────┘
│ createdAt   │          │ (FK)        │
└─────────────┘          │ createdAt   │
                         └─────────────┘
```

### 1.2 リレーション概要

```
User (1) ──── (N) Message (N) ──── (1) ChatRoom
```

- **User : Message = 1 : N**
  - 1人のユーザーは複数のメッセージを投稿できる
- **ChatRoom : Message = 1 : N**
  - 1つのチャットルームには複数のメッセージが投稿される
- **Message の位置づけ**
  - Message は「どのユーザーが」「どのチャットルームに」投稿したメッセージかを表現する中間的なエンティティ
  - User と ChatRoom を結びつける役割を持つ

---

## 2. 各モデルのフィールド定義とリレーション説明

### 2.1 User モデル

ユーザー情報を管理するモデル。

| フィールド名 | 概念的な型   | 説明                           |
|-------------|-------------|--------------------------------|
| id          | integer     | 主キー、自動採番               |
| username    | string      | ユーザー名（一意）             |
| email       | string      | メールアドレス（一意）         |
| password    | string      | パスワード（ハッシュ化済み）   |
| createdAt   | datetime    | 作成日時                       |

**リレーション:**
- `messages`: 1対多の関係で複数の Message を持つ

### 2.2 ChatRoom モデル

チャットルーム情報を管理するモデル。

| フィールド名 | 概念的な型   | 説明                           |
|-------------|-------------|--------------------------------|
| id          | integer     | 主キー、自動採番               |
| name        | string      | チャットルーム名               |
| createdAt   | datetime    | 作成日時                       |

**リレーション:**
- `messages`: 1対多の関係で複数の Message を持つ

### 2.3 Message モデル

チャットメッセージを管理するモデル。

| フィールド名  | 概念的な型   | 説明                                   |
|--------------|-------------|----------------------------------------|
| id           | integer     | 主キー、自動採番                       |
| content      | text        | メッセージ本文（長文対応）             |
| userId       | integer     | 外部キー：投稿者の User.id を参照      |
| chatRoomId   | integer     | 外部キー：投稿先の ChatRoom.id を参照  |
| createdAt    | datetime    | 作成日時                               |

**リレーション:**
- `user`: 多対1の関係で User に属する（どのユーザーが投稿したか）
- `chatRoom`: 多対1の関係で ChatRoom に属する（どのルームに投稿されたか）

---

## 3. MySQL を採用した理由と設定上の注意点

### 3.1 MySQL 採用理由

- **豊富な実績と安定性**
  - 世界中で広く使用されており、長年の運用実績がある
  - 多くの本番環境で検証済みの安定したRDBMS

- **運用ノウハウの豊富さ**
  - 日本語の技術資料・書籍が充実
  - トラブルシューティングの情報が得やすい

- **ホスティングサービスの対応状況**
  - AWS RDS、Google Cloud SQL、Azure Database など主要クラウドサービスが対応
  - 共有ホスティングでも広くサポートされている

- **Prisma との相性**
  - Prisma ORM が MySQL を公式サポート
  - マイグレーションやスキーマ管理が容易

- **コミュニティの活発さ**
  - オープンソースコミュニティが活発
  - 継続的なアップデートとセキュリティパッチの提供

### 3.2 設定上の注意点

#### 文字コード設定

- **utf8mb4 の採用理由**
  - MySQL の `utf8` は3バイトまでしか対応せず、4バイト文字（絵文字等）を格納できない
  - `utf8mb4` は4バイトUTF-8に完全対応し、絵文字や特殊文字を正しく保存可能
  - 多言語対応のアプリケーションに必須

#### 照合順序（Collation）

- **utf8mb4_unicode_ci の採用**
  - `utf8mb4_unicode_ci`: Unicode標準の照合順序、多言語での正確なソート
  - `utf8mb4_general_ci`: 高速だが一部の文字比較で差異あり
  - 本プロジェクトでは正確性を重視し `utf8mb4_unicode_ci` を採用

#### タイムゾーン設定

- サーバーのタイムゾーンを UTC に統一することを推奨
- アプリケーション側でローカルタイムへの変換を行う
- Docker環境では `TZ=UTC` 環境変数で設定可能

---

## 4. 補足事項

### 4.1 パスワードの取り扱い

- パスワードは平文で保存せず、必ずハッシュ化して格納する
- 推奨ハッシュアルゴリズム: bcrypt または Argon2

### 4.2 インデックス設計の方針

- 主キーには自動的にインデックスが付与される
- 外部キー（userId, chatRoomId）にもインデックスを付与し、JOIN性能を確保
- email フィールドにはユニークインデックスを付与（ログイン時の検索高速化）
